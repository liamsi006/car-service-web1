<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Service Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .login-box p {
            margin-bottom: 30px;
            color: #7f8c8d;
        }

        .car-icon {
            font-size: 3rem;
            color: #3498db;
            margin-bottom: 20px;
        }

        .password-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: border 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .login-error {
            color: #e74c3c;
            margin-bottom: 15px;
            display: none;
        }

        /* Main App (hidden by default) */
        .main-app {
            display: none;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .user-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .current-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .app-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-section, .records-section, .users-section {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .users-section {
            min-width: 350px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: #3498db;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .user-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .permission-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .permission-option {
            flex: 1;
            min-width: 120px;
        }

        .permission-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
            padding: 8px 12px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .permission-option input[type="checkbox"] {
            margin: 0;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .user-permissions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .permission-tag {
            background-color: #eaf2f8;
            color: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .user-actions-small {
            display: flex;
            gap: 5px;
        }

        .oil-options {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #3498db;
        }

        .oil-option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .oil-option {
            flex: 1;
            min-width: 150px;
        }

        .oil-option label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
            padding: 8px 12px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: all 0.2s;
        }

        .oil-option input[type="checkbox"] {
            margin: 0;
        }

        .oil-option.selected label {
            border-color: #2ecc71;
            background-color: #e8f8f1;
        }

        .oil-summary {
            display: none;
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f8f1;
            border-radius: 5px;
            border: 1px solid #2ecc71;
        }

        .oil-summary h4 {
            margin-bottom: 8px;
            color: #27ae60;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .oil-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .oil-tag {
            background-color: #2ecc71;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .btn-logout {
            background-color: #7f8c8d;
        }

        .btn-logout:hover {
            background-color: #636e72;
        }

        .btn-manage-users {
            background-color: #9b59b6;
        }

        .btn-manage-users:hover {
            background-color: #8e44ad;
        }

        .btn-delete {
            background-color: #e74c3c;
        }

        .btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-edit {
            background-color: #f39c12;
        }

        .btn-edit:hover {
            background-color: #d68910;
        }

        .btn-share {
            background-color: #2ecc71;
        }

        .btn-share:hover {
            background-color: #27ae60;
        }

        .record-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
            transition: transform 0.2s;
        }

        .record-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .car-type {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.2rem;
        }

        .service-type {
            display: inline-block;
            background-color: #eaf2f8;
            color: #3498db;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .detail-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .record-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
            color: #7f8c8d;
            display: flex;
            justify-content: space-between;
        }

        .record-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .oil-info-container {
            margin-top: 10px;
        }

        .oil-tags-record {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }

        .oil-tag-record {
            background-color: #fff9e6;
            color: #f39c12;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            border: 1px solid #f1c40f;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .share-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .share-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 15px;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .share-option:hover {
            background-color: #f8f9fa;
        }

        .share-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }

        .email-icon {
            background-color: #3498db;
        }

        .whatsapp-icon {
            background-color: #25D366;
        }

        .link-icon {
            background-color: #9b59b6;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .empty-records, .empty-users {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }

        .empty-records i, .empty-users i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        @media (max-width: 1100px) {
            .app-wrapper {
                flex-direction: column;
            }
            
            .record-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .record-actions {
                flex-direction: column;
            }
            
            .btn-share {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .oil-option {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-box">
                <div class="car-icon">
                    <i class="fas fa-car"></i>
                </div>
                <h2>Car Service Tracker</h2>
                <p>Track and manage vehicle maintenance records</p>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i> Incorrect password. Please try again.
                </div>
                
                <input type="password" id="passwordInput" class="password-input" placeholder="Enter access password">
                <button class="btn" id="loginBtn">
                    <i class="fas fa-lock"></i> Access App
                </button>
                
                <div style="margin-top: 20px; font-size: 0.9rem; color: #95a5a6;">
                    <p><i class="fas fa-info-circle"></i> Password-protected access for authorized users</p>
                </div>
            </div>
        </div>

        <!-- Main App (hidden until login) -->
        <div class="main-app" id="mainApp">
            <header>
                <h1><i class="fas fa-car"></i> Car Service Tracker</h1>
                <p>Vehicle maintenance records and service history</p>
                <div class="user-info-bar">
                    <div class="current-user">
                        <i class="fas fa-user-circle"></i>
                        <span id="currentUserName">Loading...</span>
                        <span class="user-role" id="currentUserRole">Loading...</span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-manage-users" id="manageUsersBtn">
                            <i class="fas fa-users-cog"></i> Manage Users
                        </button>
                        <button class="btn btn-logout" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </header>

            <div class="app-wrapper">
                <!-- Form Section -->
                <section class="form-section" id="formSection">
                    <h2 class="section-title"><i class="fas fa-plus-circle"></i> Add Service Record</h2>
                    <form id="serviceForm">
                        <div class="form-group">
                            <label for="carType"><i class="fas fa-car"></i> Car Type / Model</label>
                            <input type="text" id="carType" class="form-control" placeholder="e.g., Toyota Camry 2020" required>
                        </div>

                        <div class="form-group">
                            <label for="serviceType"><i class="fas fa-tools"></i> Type of Service</label>
                            <select id="serviceType" class="form-control" required>
                                <option value="">Select a service type</option>
                                <option value="Oil Change">Oil Change</option>
                                <option value="Brake Service">Brake Service</option>
                                <option value="Tire Rotation">Tire Rotation</option>
                                <option value="Engine Tune-up">Engine Tune-up</option>
                                <option value="Transmission Service">Transmission Service</option>
                                <option value="AC Service">AC Service</option>
                                <option value="Battery Replacement">Battery Replacement</option>
                                <option value="General Maintenance">General Maintenance</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Oil Type Selection (Visible only when Oil Change is selected) -->
                        <div id="oilOptions" class="oil-options">
                            <label><i class="fas fa-oil-can"></i> Select Oil Type(s)</label>
                            <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> You can select multiple oil types for comprehensive oil change services
                            </p>
                            <div class="oil-option-group">
                                <div class="oil-option">
                                    <input type="checkbox" id="engineOil" name="oilType" value="Engine Oil">
                                    <label for="engineOil">Engine Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="gearOil" name="oilType" value="Gear Oil">
                                    <label for="gearOil">Gear Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="transmissionOil" name="oilType" value="Transmission Oil">
                                    <label for="transmissionOil">Transmission Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="differentialOil" name="oilType" value="Differential Oil">
                                    <label for="differentialOil">Differential Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="syntheticOil" name="oilType" value="Full Synthetic Oil">
                                    <label for="syntheticOil">Full Synthetic Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="semiSyntheticOil" name="oilType" value="Semi-Synthetic Oil">
                                    <label for="semiSyntheticOil">Semi-Synthetic Oil</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="brakeFluid" name="oilType" value="Brake Fluid">
                                    <label for="brakeFluid">Brake Fluid</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="powerSteeringFluid" name="oilType" value="Power Steering Fluid">
                                    <label for="powerSteeringFluid">Power Steering Fluid</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="coolant" name="oilType" value="Coolant">
                                    <label for="coolant">Coolant</label>
                                </div>
                                <div class="oil-option">
                                    <input type="checkbox" id="otherOil" name="oilType" value="Other Oil Type">
                                    <label for="otherOil">Other Oil Type</label>
                                </div>
                            </div>
                            
                            <!-- Selected oil types summary -->
                            <div id="oilSummary" class="oil-summary">
                                <h4><i class="fas fa-check-circle"></i> Selected Oil Types</h4>
                                <div id="selectedOilTags" class="oil-tags">
                                    <!-- Selected oil tags will appear here -->
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="serviceDate"><i class="fas fa-calendar-alt"></i> Service Date</label>
                            <input type="date" id="serviceDate" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="price"><i class="fas fa-dollar-sign"></i> Price</label>
                            <input type="number" id="price" class="form-control" placeholder="e.g., 150.00" step="0.01" required>
                        </div>

                        <div class="form-group">
                            <label for="notes"><i class="fas fa-sticky-note"></i> Additional Notes</label>
                            <textarea id="notes" class="form-control" rows="3" placeholder="Any additional details about the service..."></textarea>
                        </div>

                        <button type="submit" class="btn" id="saveRecordBtn">
                            <i class="fas fa-save"></i> Save Service Record
                        </button>
                    </form>
                </section>

                <!-- Records Section -->
                <section class="records-section" id="recordsSection">
                    <h2 class="section-title"><i class="fas fa-history"></i> Service History</h2>
                    <div id="recordsList">
                        <!-- Records will be displayed here -->
                        <div class="empty-records">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>No Service Records Yet</h3>
                            <p>Add your first car service record using the form on the left</p>
                        </div>
                    </div>
                </section>

                <!-- Users Management Section (hidden by default) -->
                <section class="users-section" id="usersSection" style="display: none;">
                    <h2 class="section-title"><i class="fas fa-users-cog"></i> Manage Users</h2>
                    
                    <div class="user-form">
                        <h3 style="margin-bottom: 15px; color: #2c3e50;">
                            <i class="fas fa-user-plus"></i> Add New User
                        </h3>
                        <form id="userForm">
                            <div class="form-group">
                                <label for="userName"><i class="fas fa-user"></i> Full Name</label>
                                <input type="text" id="userName" class="form-control" placeholder="Enter full name" required>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-shield-alt"></i> Permissions</label>
                                <div class="permission-options">
                                    <div class="permission-option">
                                        <input type="checkbox" id="permAdd" name="permissions" value="add" checked>
                                        <label for="permAdd">Add Records</label>
                                    </div>
                                    <div class="permission-option">
                                        <input type="checkbox" id="permEdit" name="permissions" value="edit">
                                        <label for="permEdit">Edit Records</label>
                                    </div>
                                    <div class="permission-option">
                                        <input type="checkbox" id="permDelete" name="permissions" value="delete">
                                        <label for="permDelete">Delete Records</label>
                                    </div>
                                    <div class="permission-option">
                                        <input type="checkbox" id="permShare" name="permissions" value="share">
                                        <label for="permShare">Share Records</label>
                                    </div>
                                    <div class="permission-option">
                                        <input type="checkbox" id="permManageUsers" name="permissions" value="manage_users">
                                        <label for="permManageUsers">Manage Users</label>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn">
                                <i class="fas fa-user-plus"></i> Add User
                            </button>
                        </form>
                    </div>
                    
                    <h3 style="margin: 25px 0 15px 0; color: #2c3e50;">
                        <i class="fas fa-users"></i> Current Users
                    </h3>
                    <div class="user-list" id="userList">
                        <!-- Users will be displayed here -->
                        <div class="empty-users">
                            <i class="fas fa-users"></i>
                            <h3>No Users Added</h3>
                            <p>Add your first user using the form above</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" id="backToMainBtn">
                            <i class="fas fa-arrow-left"></i> Back to Service Records
                        </button>
                    </div>
                </section>
            </div>

            <!-- Share Modal -->
            <div id="shareModal" class="share-modal">
                <div class="share-content">
                    <button class="close-modal" id="closeModal">&times;</button>
                    <h2 class="section-title"><i class="fas fa-share-alt"></i> Share Service Record</h2>
                    <p id="shareRecordText"></p>
                    
                    <div class="share-options">
                        <div class="share-option" id="shareEmail">
                            <div class="share-icon email-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <span>Email</span>
                        </div>
                        
                        <div class="share-option" id="shareWhatsApp">
                            <div class="share-icon whatsapp-icon">
                                <i class="fab fa-whatsapp"></i>
                            </div>
                            <span>WhatsApp</span>
                        </div>
                        
                        <div class="share-option" id="shareLink">
                            <div class="share-icon link-icon">
                                <i class="fas fa-link"></i>
                            </div>
                            <span>Copy Link</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <p style="font-size: 0.9rem; color: #7f8c8d;">
                            The record will be shared as text with all the details
                        </p>
                    </div>
                </div>
            </div>

            <footer>
                <p>Car Service Tracker &copy; 2026 | Vehicle maintenance records system</p>
                <p>Developed by Liamsi006</p>
            </footer>
        </div>
    </div>

    <script>
        // Access password
        const ACCESS_PASSWORD = "tracker123";
        
        // Permission constants
        const PERMISSIONS = {
            ADD: 'add',
            EDIT: 'edit',
            DELETE: 'delete',
            SHARE: 'share',
            MANAGE_USERS: 'manage_users'
        };
        
        // Default admin user
        const defaultAdminUser = {
            id: 1,
            name: "Admin User",
            permissions: [PERMISSIONS.ADD, PERMISSIONS.EDIT, PERMISSIONS.DELETE, PERMISSIONS.SHARE, PERMISSIONS.MANAGE_USERS],
            role: "Administrator",
            isActive: true
        };
        
        // Global variables
        let serviceRecords = [];
        let users = [];
        // DO NOT auto-login on load: start with no currentUser
        let currentUser = null;
        let currentRecordToShare = null;

        // DOM Elements (will be assigned on DOMContentLoaded)
        let loginScreen, mainApp, passwordInput, loginBtn, loginError, logoutBtn, manageUsersBtn;
        let currentUserName, currentUserRole, serviceForm, serviceTypeSelect, oilOptionsDiv, oilSummaryDiv, selectedOilTagsDiv;
        let recordsList, shareModal, closeModal, shareRecordText, shareEmail, shareWhatsApp, shareLink;
        let formSection, recordsSection, usersSection, userForm, userList, backToMainBtn, saveRecordBtn;

        function initializeData() {
            serviceRecords = [];
            users = [defaultAdminUser];
            currentUser = null; // do not auto-login

            renderUsers();
            renderRecords();
        }

        function showLoginScreen() {
            loginScreen.style.display = 'flex';
            mainApp.style.display = 'none';
            currentUserName.textContent = 'Not logged in';
            currentUserRole.textContent = '';
            loginError.style.display = 'none';
        }

        function showMainApp() {
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            updateUserDisplay();
            renderRecords();
            renderUsers();
        }

        function updateUserDisplay() {
            if (currentUser) {
                currentUserName.textContent = currentUser.name;
                currentUserRole.textContent = currentUser.role || '';
            } else {
                currentUserName.textContent = 'Not logged in';
                currentUserRole.textContent = '';
            }
        }

        function handleLogin() {
            const enteredPassword = passwordInput.value.trim();
            if (enteredPassword === ACCESS_PASSWORD) {
                // Successful login: sign in as default admin (or later implement user selection)
                currentUser = defaultAdminUser;
                passwordInput.value = '';
                loginError.style.display = 'none';
                showMainApp();
            } else {
                loginError.style.display = 'block';
            }
        }

        function handleLogout() {
            currentUser = null;
            showLoginScreen();
        }

        function toggleUsersSection() {
            if (!currentUser || !currentUser.permissions.includes(PERMISSIONS.MANAGE_USERS)) {
                alert('You do not have permission to manage users.');
                return;
            }
            usersSection.style.display = 'block';
            recordsSection.style.display = 'none';
            formSection.style.display = 'none';
        }

        function backToMainFromUsers() {
            usersSection.style.display = 'none';
            recordsSection.style.display = 'block';
            formSection.style.display = 'block';
        }

        function handleServiceTypeChange() {
            const val = serviceTypeSelect.value;
            if (val === 'Oil Change') {
                oilOptionsDiv.style.display = 'block';
            } else {
                oilOptionsDiv.style.display = 'none';
                hideOilSummary();
                // clear oil checkboxes
                const checkboxes = oilOptionsDiv.querySelectorAll('input[name="oilType"]');
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        function updateOilSummary() {
            const checked = Array.from(oilOptionsDiv.querySelectorAll('input[name="oilType"]:checked'));
            selectedOilTagsDiv.innerHTML = '';
            if (checked.length === 0) {
                hideOilSummary();
                return;
            }
            checked.forEach(cb => {
                const tag = document.createElement('div');
                tag.className = 'oil-tag';
                tag.textContent = cb.value;
                selectedOilTagsDiv.appendChild(tag);
            });
            oilSummaryDiv.style.display = 'block';
        }

        function hideOilSummary() {
            oilSummaryDiv.style.display = 'none';
            selectedOilTagsDiv.innerHTML = '';
        }

        function renderRecords() {
            recordsList.innerHTML = '';
            if (serviceRecords.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-records';
                empty.innerHTML = '<i class="fas fa-clipboard-list"></i><h3>No Service Records Yet</h3><p>Add your first car service record using the form on the left</p>';
                recordsList.appendChild(empty);
                return;
            }

            serviceRecords.slice().reverse().forEach(record => {
                const item = document.createElement('div');
                item.className = 'record-item';

                const header = document.createElement('div');
                header.className = 'record-header';
                header.innerHTML = `<div class="car-type">${escapeHtml(record.carType)}</div><div class="service-type">${escapeHtml(record.serviceType)}</div>`;
                item.appendChild(header);

                const details = document.createElement('div');
                details.className = 'record-details';

                details.appendChild(detailElement('Date', record.serviceDate));
                details.appendChild(detailElement('Price', record.price ? `$${parseFloat(record.price).toFixed(2)}` : '-'));
                details.appendChild(detailElement('Notes', escapeHtml(record.notes || '-')));
                if (record.oilTypes && record.oilTypes.length > 0) {
                    const oilDiv = document.createElement('div');
                    oilDiv.className = 'detail-item';
                    const label = document.createElement('div');
                    label.className = 'detail-label';
                    label.textContent = 'Oil Types';
                    const val = document.createElement('div');
                    val.className = 'detail-value';
                    const tags = document.createElement('div');
                    tags.className = 'oil-tags-record';
                    record.oilTypes.forEach(t => {
                        const tag = document.createElement('div');
                        tag.className = 'oil-tag-record';
                        tag.textContent = t;
                        tags.appendChild(tag);
                    });
                    val.appendChild(tags);
                    oilDiv.appendChild(label);
                    oilDiv.appendChild(val);
                    details.appendChild(oilDiv);
                }

                item.appendChild(details);

                const actions = document.createElement('div');
                actions.className = 'record-actions';

                const shareBtn = document.createElement('button');
                shareBtn.className = 'btn btn-share btn-small';
                shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share';
                shareBtn.addEventListener('click', () => openShareModal(record.id));
                actions.appendChild(shareBtn);

                if (currentUser && currentUser.permissions.includes(PERMISSIONS.EDIT)) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn btn-edit btn-small';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
                    editBtn.addEventListener('click', () => editRecord(record.id));
                    actions.appendChild(editBtn);
                }

                if (currentUser && currentUser.permissions.includes(PERMISSIONS.DELETE)) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-delete btn-small';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                    deleteBtn.addEventListener('click', () => deleteRecord(record.id));
                    actions.appendChild(deleteBtn);
                }

                item.appendChild(actions);

                const footer = document.createElement('div');
                footer.className = 'record-footer';
                footer.innerHTML = `<div>Recorded by: ${escapeHtml(record.recordedBy || 'N/A')}</div><div>${new Date(record.createdAt).toLocaleString()}</div>`;
                item.appendChild(footer);

                recordsList.appendChild(item);
            });
        }

        function detailElement(labelText, valueText) {
            const el = document.createElement('div');
            el.className = 'detail-item';
            const label = document.createElement('div');
            label.className = 'detail-label';
            label.textContent = labelText;
            const val = document.createElement('div');
            val.className = 'detail-value';
            val.textContent = valueText;
            el.appendChild(label);
            el.appendChild(val);
            return el;
        }

        function openShareModal(recordId) {
            const record = serviceRecords.find(r => r.id === recordId);
            if (!record) return;
            currentRecordToShare = record;
            shareRecordText.textContent = formatRecordText(record);
            shareModal.style.display = 'flex';
        }

        function closeShareModal() {
            currentRecordToShare = null;
            shareModal.style.display = 'none';
        }

        function formatRecordText(record) {
            const lines = [];
            lines.push(`Car: ${record.carType}`);
            lines.push(`Service: ${record.serviceType}`);
            lines.push(`Date: ${record.serviceDate}`);
            lines.push(`Price: ${record.price ? `$${parseFloat(record.price).toFixed(2)}` : '-'}`);
            if (record.oilTypes && record.oilTypes.length) {
                lines.push(`Oil Types: ${record.oilTypes.join(', ')}`);
            }
            if (record.notes) lines.push(`Notes: ${record.notes}`);
            lines.push(`Recorded by: ${record.recordedBy || 'N/A'}`);
            return lines.join('\n');
        }

        function shareByEmail() {
            if (!currentRecordToShare) return;
            const subject = encodeURIComponent('Service Record: ' + currentRecordToShare.carType);
            const body = encodeURIComponent(formatRecordText(currentRecordToShare));
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function shareByWhatsApp() {
            if (!currentRecordToShare) return;
            const text = encodeURIComponent(formatRecordText(currentRecordToShare));
            const url = `https://api.whatsapp.com/send?text=${text}`;
            window.open(url, '_blank');
        }

        function copyShareLink() {
            if (!currentRecordToShare) return;
            const text = formatRecordText(currentRecordToShare);
            navigator.clipboard?.writeText(text).then(() => {
                alert('Record text copied to clipboard.');
            }).catch(() => {
                alert('Unable to copy to clipboard.');
            });
        }

        function editRecord(recordId) {
            const record = serviceRecords.find(r => r.id === recordId);
            if (!record) return;
            // populate form for editing
            document.getElementById('carType').value = record.carType;
            document.getElementById('serviceType').value = record.serviceType;
            document.getElementById('serviceDate').value = record.serviceDate;
            document.getElementById('price').value = record.price;
            document.getElementById('notes').value = record.notes || '';
            handleServiceTypeChange();
            // set oil checkboxes
            const checkboxes = oilOptionsDiv.querySelectorAll('input[name="oilType"]');
            checkboxes.forEach(cb => cb.checked = record.oilTypes?.includes(cb.value) || false);
            updateOilSummary();

            // remove old id if editing (simple approach: delete old, let submit create new)
            deleteRecord(recordId, false);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteRecord(recordId, confirmDelete = true) {
            if (confirmDelete && !confirm('Delete this record?')) return;
            serviceRecords = serviceRecords.filter(r => r.id !== recordId);
            renderRecords();
        }

        function handleServiceFormSubmit(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.permissions.includes(PERMISSIONS.ADD)) {
                alert('You do not have permission to add records.');
                return;
            }

            const carType = document.getElementById('carType').value.trim();
            const serviceType = document.getElementById('serviceType').value;
            const serviceDate = document.getElementById('serviceDate').value;
            const price = document.getElementById('price').value;
            const notes = document.getElementById('notes').value.trim();

            let oilTypes = [];
            if (serviceType === 'Oil Change') {
                oilTypes = Array.from(oilOptionsDiv.querySelectorAll('input[name="oilType"]:checked')).map(cb => cb.value);
            }

            const record = {
                id: Date.now(),
                carType,
                serviceType,
                serviceDate,
                price,
                notes,
                oilTypes,
                recordedBy: currentUser ? currentUser.name : 'Unknown',
                createdAt: Date.now()
            };

            serviceRecords.push(record);
            renderRecords();
            serviceForm.reset();
            document.getElementById('serviceDate').valueAsDate = new Date();
            handleServiceTypeChange();
            alert('Service record saved.');
        }

        function renderUsers() {
            userList.innerHTML = '';
            if (!users || users.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-users';
                empty.innerHTML = '<i class="fas fa-users"></i><h3>No Users Added</h3><p>Add your first user using the form above</p>';
                userList.appendChild(empty);
                return;
            }

            users.forEach(u => {
                const item = document.createElement('div');
                item.className = 'user-item';
                const details = document.createElement('div');
                details.className = 'user-details';
                details.innerHTML = `<div class="user-name">${escapeHtml(u.name)}</div>`;
                const perms = document.createElement('div');
                perms.className = 'user-permissions';
                (u.permissions || []).forEach(p => {
                    const ptag = document.createElement('div');
                    ptag.className = 'permission-tag';
                    ptag.textContent = p;
                    perms.appendChild(ptag);
                });
                details.appendChild(perms);
                item.appendChild(details);

                const actions = document.createElement('div');
                actions.className = 'user-actions-small';
                if (currentUser && currentUser.permissions.includes(PERMISSIONS.MANAGE_USERS)) {
                    const del = document.createElement('button');
                    del.className = 'btn btn-delete btn-small';
                    del.innerHTML = '<i class="fas fa-trash"></i>';
                    del.title = 'Remove user';
                    del.addEventListener('click', () => {
                        if (u.id === defaultAdminUser.id) {
                            alert('Cannot remove default admin.');
                            return;
                        }
                        if (confirm('Remove this user?')) {
                            users = users.filter(x => x.id !== u.id);
                            renderUsers();
                        }
                    });
                    actions.appendChild(del);
                }
                item.appendChild(actions);

                userList.appendChild(item);
            });
        }

        function handleUserFormSubmit(e) {
            e.preventDefault();
            if (!currentUser || !currentUser.permissions.includes(PERMISSIONS.MANAGE_USERS)) {
                alert('You do not have permission to add users.');
                return;
            }
            const name = document.getElementById('userName').value.trim();
            const perms = Array.from(document.querySelectorAll('#userForm input[name="permissions"]:checked')).map(cb => cb.value);

            const newUser = {
                id: Date.now(),
                name,
                permissions: perms,
                role: perms.includes(PERMISSIONS.MANAGE_USERS) ? 'Administrator' : 'User',
                isActive: true
            };
            users.push(newUser);
            renderUsers();
            userForm.reset();
            alert('User added.');
        }

        // Utility: basic HTML escape to avoid injection in simple text nodes
        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str).replace(/[&<>"'`=\/]/g, function(s) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;',
                    '/': '&#x2F;',
                    '=': '&#x3D;',
                    '`': '&#x60;'
                }[s];
            });
        }

        // Attach listeners and initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // assign DOM elements
            loginScreen = document.getElementById('loginScreen');
            mainApp = document.getElementById('mainApp');
            passwordInput = document.getElementById('passwordInput');
            loginBtn = document.getElementById('loginBtn');
            loginError = document.getElementById('loginError');
            logoutBtn = document.getElementById('logoutBtn');
            manageUsersBtn = document.getElementById('manageUsersBtn');
            currentUserName = document.getElementById('currentUserName');
            currentUserRole = document.getElementById('currentUserRole');
            serviceForm = document.getElementById('serviceForm');
            serviceTypeSelect = document.getElementById('serviceType');
            oilOptionsDiv = document.getElementById('oilOptions');
            oilSummaryDiv = document.getElementById('oilSummary');
            selectedOilTagsDiv = document.getElementById('selectedOilTags');
            recordsList = document.getElementById('recordsList');
            shareModal = document.getElementById('shareModal');
            closeModal = document.getElementById('closeModal');
            shareRecordText = document.getElementById('shareRecordText');
            shareEmail = document.getElementById('shareEmail');
            shareWhatsApp = document.getElementById('shareWhatsApp');
            shareLink = document.getElementById('shareLink');
            formSection = document.getElementById('formSection');
            recordsSection = document.getElementById('recordsSection');
            usersSection = document.getElementById('usersSection');
            userForm = document.getElementById('userForm');
            userList = document.getElementById('userList');
            backToMainBtn = document.getElementById('backToMainBtn');
            saveRecordBtn = document.getElementById('saveRecordBtn');

            // Initialize date field
            try {
                document.getElementById('serviceDate').valueAsDate = new Date();
            } catch (err) {
                // ignore if not supported
            }

            // Initialize data
            initializeData();

            // Ensure login screen is shown at start (no auto-login)
            showLoginScreen();

            // event listeners
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            logoutBtn.addEventListener('click', handleLogout);
            manageUsersBtn.addEventListener('click', toggleUsersSection);
            backToMainBtn.addEventListener('click', backToMainFromUsers);
            serviceTypeSelect.addEventListener('change', handleServiceTypeChange);
            serviceForm.addEventListener('submit', handleServiceFormSubmit);
            userForm.addEventListener('submit', handleUserFormSubmit);
            closeModal.addEventListener('click', closeShareModal);
            shareEmail.addEventListener('click', shareByEmail);
            shareWhatsApp.addEventListener('click', shareByWhatsApp);
            shareLink.addEventListener('click', copyShareLink);

            // oil checkbox changes
            oilOptionsDiv.querySelectorAll('input[name="oilType"]').forEach(cb => {
                cb.addEventListener('change', updateOilSummary);
            });

            // Click outside share content to close
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) closeShareModal();
            });
        });
    </script>
</body>
</html>